<?php

function perms_to_rwx($perms) {
    $info = '';
    if (($perms & 0xC000) === 0xC000) $info .= 's';
    elseif (($perms & 0xA000) === 0xA000) $info .= 'l';
    elseif (($perms & 0x8000) === 0x8000) $info .= '-';
    elseif (($perms & 0x6000) === 0x6000) $info .= 'b';
    elseif (($perms & 0x4000) === 0x4000) $info .= 'd';
    elseif (($perms & 0x2000) === 0x2000) $info .= 'c';
    else $info .= 'u';

    $info .= (($perms & 0x0100) ? 'r' : '-');
    $info .= (($perms & 0x0080) ? 'w' : '-');
    $info .= (($perms & 0x0040) ? (($perms & 0x0800) ? 's' : 'x') : (($perms & 0x0800) ? 'S' : '-'));

    $info .= (($perms & 0x0020) ? 'r' : '-');
    $info .= (($perms & 0x0010) ? 'w' : '-');
    $info .= (($perms & 0x0008) ? (($perms & 0x0400) ? 's' : 'x') : (($perms & 0x0400) ? 'S' : '-'));

    $info .= (($perms & 0x0004) ? 'r' : '-');
    $info .= (($perms & 0x0002) ? 'w' : '-');
    $info .= (($perms & 0x0001) ? (($perms & 0x0200) ? 't' : 'x') : (($perms & 0x0200) ? 'T' : '-'));

    return $info;
}

function uid_to_name($uid) {
    if (function_exists('posix_getpwuid')) {
        $pw = @posix_getpwuid($uid);
        if ($pw && isset($pw['name'])) return $pw['name'];
    }
    if (is_readable('/etc/passwd')) {
        $lines = @file('/etc/passwd', FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        if ($lines) {
            foreach ($lines as $line) {
                $parts = explode(':', $line);
                if (count($parts) >= 3 && (int)$parts[2] === (int)$uid) return $parts[0];
            }
        }
    }
    return null;
}

function gid_to_name($gid) {
    if (function_exists('posix_getgrgid')) {
        $gr = @posix_getgrgid($gid);
        if ($gr && isset($gr['name'])) return $gr['name'];
    }
    if (is_readable('/etc/group')) {
        $lines = @file('/etc/group', FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        if ($lines) {
            foreach ($lines as $line) {
                $parts = explode(':', $line);
                if (count($parts) >= 3 && (int)$parts[2] === (int)$gid) return $parts[0];
            }
        }
    }
    return null;
}

function stat_path($path) {
    $path = (string)$path;
    $exists = file_exists($path) || is_link($path);
    if (!$exists) {
        return array('path'=>$path, 'exists'=>false, 'error'=>'not_found');
    }

    $perms = @fileperms($path);
    $owner = @fileowner($path);
    $group = @filegroup($path);

    $r = @is_readable($path) ? true : false;
    $w = @is_writable($path) ? true : false;
    $x = @is_executable($path) ? true : false;

    $owner_name = uid_to_name($owner);
    $group_name = gid_to_name($group);

    return array(
        'path'          => $path,
        'exists'        => true,
        'type_perms'    => perms_to_rwx($perms),
        'perms_octal'   => sprintf('%04o', $perms & 0x0FFF),
        'owner_uid'     => $owner,
        'owner_name'    => $owner_name,
        'group_gid'     => $group,
        'group_name'    => $group_name,
        'is_readable'   => $r,
        'is_writable'   => $w,
        'is_executable' => $x,
        'note'          => '심볼릭 링크 타깃 확인(readlink) 불가 또는 disabled일 수 있음'
    );
}

// --- 웹 처리부 ---
$submitted = false;
$result = null;
$err = null;
$input_path = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $submitted = true;
    $input_path = isset($_POST['path']) ? trim($_POST['path']) : '';
    if ($input_path === '') {
        $err = '파일 경로를 입력하세요.';
    } else {
        // 간단한 정리: 경로 앞/뒤 공백 제거, null 바이트 제거
        $input_path = str_replace("\0", '', $input_path);
        // (옵션) 여기서 open_basedir 같은 서버 설정 제한이 걸릴 수 있음 - 실패 시 에러 반환
        $result = stat_path($input_path);
    }
}

// --- HTML 출력 ---
?><!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PermCheck</title>
<style>
body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial; background:#f6f7fb; color:#111; padding:20px}
.container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
h1{margin-top:0;font-size:20px}
form{margin-bottom:14px}
.input-row{display:flex;gap:8px}
.input-row input[type="text"]{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
.input-row button{padding:8px 12px;border:0;background:#2563eb;color:#fff;border-radius:6px;cursor:pointer}
.note{font-size:13px;color:#666;margin-top:6px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
.bad{color:#b91c1c;font-weight:600}
.good{color:#047857;font-weight:600}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="container">
  <h1>파일 권한 확인 (PHP 5.6.40)</h1>

  <form method="post" action="">
    <div class="input-row">
      <input type="text" name="path" placeholder="/path/to/file" value="<?php echo htmlspecialchars($input_path, ENT_QUOTES, 'UTF-8'); ?>"/>
      <button type="submit">확인</button>
    </div>
    <div class="note">
      서버 로컬 경로를 입력하세요. (예: <code>/etc/passwd</code>, <code>/var/www/html/index.php</code>)<br>
      주의: 민감한 파일을 노출하지 마세요. 일부 서버 설정(open_basedir, 권한 등) 때문에 접근이 차단될 수 있습니다.
    </div>
  </form>

<?php if ($submitted): ?>
    <?php if ($err): ?>
      <div class="bad"><?php echo htmlspecialchars($err, ENT_QUOTES, 'UTF-8'); ?></div>
    <?php else: ?>
      <?php if (!$result['exists']): ?>
        <div class="bad">파일을 찾을 수 없습니다: <?php echo htmlspecialchars($result['path'], ENT_QUOTES, 'UTF-8'); ?></div>
      <?php else: ?>
        <table class="table" role="table" aria-label="file-info">
          <tr><th>항목</th><th>값</th></tr>
          <tr><td>경로</td><td><?php echo htmlspecialchars($result['path'], ENT_QUOTES, 'UTF-8'); ?></td></tr>
          <tr><td>파일 타입 + 권한</td><td><code><?php echo htmlspecialchars($result['type_perms'], ENT_QUOTES, 'UTF-8'); ?></code></td></tr>
          <tr><td>권한 (octal)</td><td><code><?php echo htmlspecialchars($result['perms_octal'], ENT_QUOTES, 'UTF-8'); ?></code></td></tr>
          <tr><td>소유자 (UID)</td><td><?php echo ($result['owner_name'] ? htmlspecialchars($result['owner_name'], ENT_QUOTES, 'UTF-8') : htmlspecialchars($result['owner_uid'], ENT_QUOTES, 'UTF-8')); ?></td></tr>
          <tr><td>그룹 (GID)</td><td><?php echo ($result['group_name'] ? htmlspecialchars($result['group_name'], ENT_QUOTES, 'UTF-8') : htmlspecialchars($result['group_gid'], ENT_QUOTES, 'UTF-8')); ?></td></tr>
          <tr><td>읽기 가능</td><td><?php echo $result['is_readable'] ? '<span class="good">Yes</span>' : '<span class="bad">No</span>'; ?></td></tr>
          <tr><td>쓰기 가능</td><td><?php echo $result['is_writable'] ? '<span class="good">Yes</span>' : '<span class="bad">No</span>'; ?></td></tr>
          <tr><td>실행 가능</td><td><?php echo $result['is_executable'] ? '<span class="good">Yes</span>' : '<span class="bad">No</span>'; ?></td></tr>
          <tr><td>비고</td><td class="small"><?php echo htmlspecialchars($result['note'], ENT_QUOTES, 'UTF-8'); ?></td></tr>
        </table>
      <?php endif; ?>
    <?php endif; ?>
<?php endif; ?>

</div>
</body>
</html>